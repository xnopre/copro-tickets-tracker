# Étape 6 : Changer le Statut et Assigner un Ticket

**Objectif** : Modifier le statut d'un ticket (NEW → IN_PROGRESS → RESOLVED → CLOSED) avec assignation obligatoire de la personne en charge

## Ce qu'on livre

- Un formulaire pour changer le statut dans la page de détail
- Un champ obligatoire pour saisir le nom de la personne assignée
- Validation : impossible de changer le statut sans nom
- Les changements de statut et d'assignation sont sauvegardés
- Le statut et la personne assignée se reflètent dans la liste

## Tâches

- [x] Ajouter le champ `assignedTo` (string | null) dans le type Ticket
- [x] Mettre à jour le schéma Mongoose avec le champ `assignedTo` (default: null)
- [x] Créer l'API route `PATCH /api/tickets/[id]` (pour statut + assignation)
- [x] Valider côté serveur : statut + assignedTo obligatoires
- [x] Créer le composant `UpdateTicketStatusForm` avec tests (12 tests)
- [x] Le formulaire contient : sélecteur de statut + champ texte pour le nom
- [x] Validation côté client : le nom est requis
- [x] Afficher les statuts avec des couleurs différentes
- [x] Afficher la personne assignée dans la carte ticket et le détail
- [x] Mettre à jour le statut et l'assignation via l'API
- [x] Revalider les données Next.js pour refresh (router.refresh())
- [x] Mettre à jour les tests existants (145 tests passants)
- [x] Créer tests unitaires pour le use case UpdateTicket (4 tests)
- [ ] Déployer

## Validation

- ✅ On ne peut pas changer le statut sans saisir un nom
- ✅ Le formulaire affiche une erreur si le nom est vide
- ✅ On peut changer le statut ET saisir le nom en même temps
- ✅ Les changements sont sauvegardés dans MongoDB
- ✅ Le nouveau statut et la personne assignée apparaissent dans la liste et le détail
- ✅ Les couleurs changent selon le statut
- ✅ L'architecture hexagonale est respectée
- ✅ Tous les tests passent (145/145)
- ✅ Le build TypeScript et Next.js fonctionnent
- ⏳ Déployé en production (en attente)

## Notes techniques

**Architecture hexagonale** :

- Entité `Ticket` mise à jour avec `assignedTo: string | null`
- Interface `UpdateTicketData` ajoutée avec `status` et `assignedTo`
- Use case `UpdateTicket` créé
- Méthode `update()` ajoutée dans `ITicketRepository` et `MongoTicketRepository`
- Méthode `updateTicket()` ajoutée dans `TicketService`

**API Route PATCH /api/tickets/[id]** :

- Validation serveur : vérifie que `status` et `assignedTo` sont présents
- Trim automatique du champ `assignedTo`
- Gestion des erreurs : ID invalide, ticket non trouvé, erreur serveur

**Composant UpdateTicketStatusForm** :

- Affichage d'un sélecteur pour tous les statuts (NEW, IN_PROGRESS, RESOLVED, CLOSED)
- Champ texte obligatoire pour la personne assignée
- Pré-rempli avec les valeurs actuelles du ticket
- Validation côté client : empêche la soumission si `assignedTo` est vide
- Messages de succès/erreur avec ARIA
- Appel à `router.refresh()` pour mettre à jour l'affichage après succès
- 12 tests couvrant : rendu, validation, soumission, erreurs, accessibilité

**Affichage** :

- `TicketCard` affiche "Assigné à : [nom]" si le ticket est assigné
- `TicketDetail` affiche la personne assignée dans le footer et inclut le formulaire de mise à jour
- Les couleurs des statuts sont déjà gérées par les constantes existantes

**Tests** :

- Tous les mocks de tests mis à jour avec le champ `assignedTo`
- 145 tests passants au total (après amélioration de MongoTicketRepository)
- Script seed mis à jour avec des assignations exemple
- Tests unitaires dédiés pour le use case `UpdateTicket` (4 tests)
  - Test de mise à jour avec données valides
  - Test retour null quand ticket non trouvé
  - Test mise à jour vers RESOLVED
  - Test mise à jour vers CLOSED

**Optimisation MongoTicketRepository** :

- Ajout de `runValidators: true` dans `findByIdAndUpdate` pour garantir l'exécution des validateurs Mongoose lors de la mise à jour
- Option `{ new: true, runValidators: true }` assure la cohérence des données et la validation automatique
