# √âtape 2 : CI/CD avec GitHub Actions

**Objectif** : Automatiser la v√©rification des Pull Requests et l'ex√©cution des tests

## Ce qu'on livre

- Workflow GitHub Actions configur√©
- Tests automatiques sur chaque PR
- V√©rification du build TypeScript
- Protection de la branche main
- Badge de statut dans le README (optionnel)

## T√¢ches

- [x] Cr√©er le r√©pertoire `.github/workflows/`
- [x] Cr√©er le fichier `ci.yml` avec workflow GitHub Actions (Node.js 20)
- [x] Configurer l'ex√©cution des tests (`npm test`)
- [x] Configurer la v√©rification du build (`npm run build`)
- [x] Configurer le linting TypeScript (`npm run type-check`)
- [x] Tester le workflow en cr√©ant une PR de test
- [x] Configurer les r√®gles de protection de branche sur main
  - [x] Exiger que les v√©rifications de statut passent avant de merger
  - [x] Exiger que les branches soient √† jour avant de merger
  - [x] Activer la v√©rification "CI" comme obligatoire
- [x] Ajouter un badge CI dans README.md (optionnel)

## Validation

- ‚úÖ Les tests s'ex√©cutent automatiquement sur chaque PR
- ‚úÖ Le build est v√©rifi√© automatiquement
- ‚úÖ Les checks doivent passer avant de pouvoir merger
- ‚úÖ Le statut CI est visible dans les PRs

## Notes techniques

**Workflow GitHub Actions** (`.github/workflows/ci.yml`) :

- D√©clenchement : push et pull_request vers main
- Job nomm√© "CI" (pour la protection de branche)
- Node.js 20.x (LTS actuel)
- √âtapes : checkout ‚Üí setup node ‚Üí npm ci ‚Üí npm test ‚Üí npm run build ‚Üí npm run type-check

**Protection de branche** :

1. Param√®tres ‚Üí Branches ‚Üí Ajouter une r√®gle
2. Mod√®le de nom de branche : `main`
3. Exiger que les v√©rifications de statut passent avant de merger
4. Exiger que les branches soient √† jour avant de merger
5. Activer la v√©rification "CI" comme obligatoire

**Workflow de d√©veloppement** :
Voir le workflow Git complet dans [README.md](./README.md) (section "üõ°Ô∏è Protection Git").

---

# √âtape 2b : Workflows GitHub avec Claude

**Objectif** : Ajouter des workflows GitHub pour l'assistance automatique de Claude sur les PRs et issues

## Ce qu'on livre

- Workflow de revue de code automatique par Claude sur chaque PR
- Workflow d'assistance Claude via mentions @claude dans les issues et PRs
- Configuration du token OAuth pour l'authentification de Claude

## T√¢ches

- [x] Cr√©er le fichier `.github/workflows/claude-code-review.yml`
- [x] Cr√©er le fichier `.github/workflows/claude.yml`
- [x] Configurer le secret `CLAUDE_CODE_OAUTH_TOKEN` dans les param√®tres GitHub
  - Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret
- [x] Tester le workflow de revue sur une PR de test
- [x] Tester le workflow d'assistance avec @claude dans une issue

## Validation

- ‚úÖ Claude commente automatiquement les PRs avec une revue de code
- ‚úÖ On peut mentionner @claude dans les issues/PRs pour obtenir de l'aide
- ‚úÖ Les workflows s'ex√©cutent sans erreur

## Notes techniques

**Workflow Claude Code Review** (`.github/workflows/claude-code-review.yml`) :

- D√©clenchement : ouverture ou synchronisation de PR
- Revue automatique du code avec feedback sur :
  - Qualit√© du code et bonnes pratiques
  - Bugs potentiels
  - Performance et s√©curit√©
  - Couverture de tests
- Utilise les conventions du projet d√©finies dans CLAUDE.md

**Workflow Claude Assistant** (`.github/workflows/claude.yml`) :

- D√©clenchement : mention @claude dans :
  - Commentaires d'issues
  - Commentaires de PR
  - Revues de PR
  - Corps d'issues
- Claude ex√©cute les instructions fournies dans le commentaire
- Permissions : lecture du code, PRs, issues, et r√©sultats CI

**Configuration du token** :

1. G√©n√©rer un token OAuth Claude depuis [claude.ai](https://claude.ai)
2. GitHub Settings ‚Üí Secrets and variables ‚Üí Actions
3. Ajouter `CLAUDE_CODE_OAUTH_TOKEN` avec la valeur du token

---

# √âtape 2c : Renovate pour la Gestion Automatique des D√©pendances

**Objectif** : Automatiser la mise √† jour des d√©pendances npm avec Renovate Bot via GitHub Actions (self-hosted)

## Ce qu'on livre

- Renovate Bot configur√© en self-hosted via GitHub Actions
- Mise √† jour automatique des d√©pendances via Pull Requests
- Configuration personnalis√©e pour le projet (regroupement, scheduling, automerge)
- Authentification avec Personal Access Token pour cr√©er les PRs

## T√¢ches

- [x] Cr√©er le fichier de workflow `.github/workflows/renovate.yml`
  - [x] Configurer le d√©clenchement (schedule + workflow_dispatch)
  - [x] Utiliser l'image Docker officielle de Renovate
  - [x] Configurer le repository courant
  - [x] Configurer le token GitHub pour cr√©er les PRs
- [x] Cr√©er le fichier de configuration `renovate.json` √† la racine du projet
  - [x] √âtendre la configuration recommand√©e (`config:recommended`)
  - [x] Configurer le timezone (Europe/Paris)
  - [x] Configurer le regroupement des d√©pendances (mineures/patch ensemble) (avec matchPackageNames)
  - [x] Cr√©er un groupe sp√©cial pour Next.js et React
  - [x] Limiter le nombre de PRs ouvertes simultan√©ment (5 max)
  - [x] Ajouter des labels (`dependencies`, `renovate`)
  - [x] Configurer l'automerge pour les mises √† jour patch
  - [x] Cr√©er un Personal Access Token (PAT) GitHub avec les permissions requises
  - [x] Configurer le secret `RENOVATE_TOKEN` dans les param√®tres GitHub
  - [ ] Tester le workflow manuellement via "Run workflow" dans GitHub Actions
  - [ ] Valider qu'une PR de Renovate est cr√©√©e et passe les checks CI

## Validation

- ‚úÖ Le workflow Renovate s'ex√©cute automatiquement selon le schedule
- ‚úÖ Le fichier `renovate.json` est pr√©sent et valide
- ‚úÖ Workflow mis √† jour pour utiliser un PAT
- ‚è≥ PAT cr√©√© et configur√© (en attente de configuration manuelle)
- ‚è≥ Renovate cr√©e automatiquement des PRs pour les mises √† jour de d√©pendances (√† tester apr√®s config PAT)
- ‚è≥ Les PRs de Renovate d√©clenchent les workflows CI/CD (√† tester apr√®s config PAT)
- ‚è≥ Les tests passent sur les PRs de Renovate (√† tester apr√®s config PAT)

## Notes techniques

**Probl√®me identifi√©** :

Le `GITHUB_TOKEN` par d√©faut fourni par GitHub Actions a des limitations de permissions qui emp√™chent Renovate de cr√©er des Pull Requests. Les logs montrent :

```
POST https://api.github.com/repos/xnopre/copro-tickets-tracker/pulls = statusCode=403
GitHub failure: Resource not accessible by integration
```

Renovate cr√©e bien les branches (`renovate/all-patch`, `renovate/all-minor-dev`, `renovate/major-github-actions`) mais ne peut pas cr√©er les PRs associ√©es.

**Solution : Personal Access Token (PAT)** :

1. **Cr√©er un PAT** (GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Fine-grained tokens) :
   - **Name** : `Renovate Bot`
   - **Expiration** : 1 an (ou No expiration)
   - **Repository access** : `Only select repositories` ‚Üí `copro-tickets-tracker`
   - **Permissions (Repository)** :
     - ‚úÖ **Contents** : Read and write
     - ‚úÖ **Pull requests** : Read and write
     - ‚úÖ **Issues** : Read and write
     - ‚úÖ **Metadata** : Read-only (automatique)
     - ‚úÖ **Workflows** : Read and write (optionnel, pour d√©clencher les workflows CI)

2. **Ajouter le secret** :
   - Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
   - New repository secret : `RENOVATE_TOKEN`
   - Coller le token g√©n√©r√©

3. **Workflow mis √† jour** :
   - Utilise maintenant `token: ${{ secrets.RENOVATE_TOKEN }}` au lieu de `${{ secrets.GITHUB_TOKEN }}`

**Test** :

Apr√®s configuration du PAT, lancer manuellement le workflow via Actions ‚Üí Renovate ‚Üí Run workflow. Les PRs devraient √™tre cr√©√©es automatiquement pour les branches existantes.
