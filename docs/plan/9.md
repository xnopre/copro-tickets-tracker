# Étape 9 : Archiver un Ticket

**Objectif** : Permettre d'archiver un ticket (les tickets ne sont jamais supprimés)

## Ce qu'on livre

- Bouton "Archiver" dans la page de détail
- Confirmation avant archivage via une modale
- Toggle "Voir les archives" pour afficher/masquer les tickets archivés
- Les tickets archivés sont affichés en fin de liste (tri automatique)
- Badge "Archivé" visible dans les cartes de la liste et dans le détail
- Style visuel distinct pour les tickets archivés (opacité 70%, bordure grise)
- Les boutons "Modifier" et "Archiver" sont masqués pour les tickets archivés
- Protection API : interdiction de modifier un ticket archivé
- Architecture hexagonale complète avec use case ArchiveTicket
- Tests unitaires complets (342 tests passants)

## Tâches

- [x] Ajouter le champ `archived` (boolean, default: false) dans le type Ticket
- [x] Mettre à jour le schéma Mongoose avec le champ `archived`
- [x] Créer l'API route `PATCH /api/tickets/[id]/archive`
- [x] Créer l'architecture hexagonale
  - [x] Méthode `archive()` dans ITicketRepository
  - [x] Implémentation dans MongoTicketRepository
  - [x] Use case ArchiveTicket avec tests
  - [x] TicketService.archiveTicket()
- [x] Créer le composant ArchiveTicketButton avec confirmation (modale)
- [x] Implémenter le bouton "Archiver" dans la page de détail
- [x] Rediriger vers la liste après archivage
- [x] Ajouter un indicateur visuel "ARCHIVÉ" dans le détail si le ticket est archivé
- [x] Masquer les boutons Modifier et Archiver pour les tickets archivés
- [x] Ajouter un badge "Archivé" dans les cartes de la liste (TicketCard)
- [x] Ajouter un style visuel distinct (opacité 70%, bordure grise)
- [x] Implémenter le toggle "Voir les archives" dans la liste
- [x] Créer le composant TicketListWithArchiveToggle
- [x] Trier les tickets pour afficher les archivés en fin de liste
- [x] Ajouter la protection API : interdire modification d'un ticket archivé (UpdateTicket use case)
- [x] Tests unitaires complets (342 tests passants)
- [x] Build TypeScript et Next.js réussis
- [ ] Déployer

## Validation

- ✅ Le bouton "Archiver" demande confirmation via une modale
- ✅ L'archivage marque le ticket comme archived dans MongoDB
- ✅ Toggle "Voir les archives" fonctionne (masque/affiche les tickets archivés)
- ✅ Les tickets archivés sont affichés en fin de liste (tri automatique)
- ✅ Badge "Archivé" visible dans les cartes de la liste (TicketCard)
- ✅ Style visuel distinct pour les tickets archivés (opacité 70%, bordure grise)
- ✅ Les commentaires du ticket restent accessibles
- ✅ On peut toujours consulter un ticket archivé via son URL directe
- ✅ Redirection vers la liste après archivage avec router.push('/')
- ✅ Badge "ARCHIVÉ" affiché en haut du détail pour les tickets archivés
- ✅ Boutons Modifier et Archiver masqués pour les tickets archivés
- ✅ Protection API : impossible de modifier un ticket archivé (ValidationError)
- ✅ Architecture hexagonale respectée
- ✅ Tous les tests passent (342/342)
- ✅ Build TypeScript réussi
- ✅ Build Next.js réussi
- ⏳ Déployé en production (en attente)

## Notes techniques

**Architecture hexagonale** :

- Entité `Ticket` étendue avec `archived: boolean`
- Interface `ITicketRepository.archive(id: string)` ajoutée
- Use case `ArchiveTicket` créé avec tests
- Use case `UpdateTicket` enrichi avec vérification anti-modification des tickets archivés (lignes 18-20)
- Méthode `MongoTicketRepository.archive()` implémentée (appelle findByIdAndUpdate avec `{ archived: true }`)
- `MongoTicketRepository.findAll()` retourne TOUS les tickets (le tri/filtre est géré côté UI)
- `TicketService.archiveTicket()` orchestre le use case

**Composant ArchiveTicketButton** :

- État local : showConfirmation, isArchiving, error
- Modale de confirmation avec overlay (z-50)
- Gestion des états de chargement avec aria-busy
- Redirection vers "/" après succès avec router.push() + router.refresh()
- Gestion des erreurs avec affichage dans la modale
- Accessibilité : role="dialog", aria-modal, aria-labelledby
- 14 tests couvrant : rendu, confirmation, archivage, erreurs, accessibilité

**API Route PATCH /api/tickets/[id]/archive** :

- Appelle `ServiceFactory.getTicketService().archiveTicket(id)`
- Gestion des erreurs : InvalidIdError (400), NotFound (404), Server Error (500)
- 6 tests unitaires

**Affichage** :

- Badge "ARCHIVÉ" affiché dans TicketDetail (pour les tickets archivés)
- Badge "Archivé" affiché dans TicketCard (liste) avec style gris
- Bouton Modifier masqué si ticket.archived
- Bouton Archiver masqué si ticket.archived
- Style visuel dans TicketCard : `opacity-70 border-2 border-gray-300`

**Tests** :

- Tous les tests existants mis à jour avec le champ `archived: false`
- +25 nouveaux tests (use case, API route, composants)
- 342 tests passants au total

**Fichiers créés** :

- `src/domain/use-cases/ArchiveTicket.ts` + `.test.ts`
- `app/api/tickets/[id]/archive/route.ts` + `.test.ts`
- `src/presentation/components/ArchiveTicketButton.tsx` + `.test.tsx`
- `src/presentation/components/TicketListWithArchiveToggle.tsx` (composant avec toggle)

**Fichiers modifiés** :

- `src/domain/entities/Ticket.ts` (+ archived)
- `src/domain/repositories/ITicketRepository.ts` (+ archive)
- `src/domain/use-cases/UpdateTicket.ts` (+ vérification anti-modification si archivé)
- `src/infrastructure/repositories/MongoTicketRepository.ts` (+ archive, findAll retourne tous les tickets)
- `src/infrastructure/database/schemas/TicketSchema.ts` (+ archived)
- `src/presentation/components/TicketDetail.tsx` (+ badge, conditions)
- `src/presentation/components/TicketCard.tsx` (+ badge Archivé, style visuel)
- `app/page.tsx` (utilise TicketListWithArchiveToggle)
- Tous les fichiers de tests (+ archived: false dans les mocks)
